<?php
/**
 * @file
 * A module that allows importing of content in JSON format.
 */

/**
 * Implements hook_help().
 */
function contentimport_help($path, $args) {
  if ($path === 'admin/help#contentimport') {
    return '<p>' . t('A module that allows importing of content in JSON format.') . '</p>';
  }
}

/**
 * Implements hook_menu().
 */
function contentimport_menu() {
  $items['import/locate-files'] = array(
    'title' => 'Import content',
    'description' => 'Specify the location of the import files.',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('contentimport_form'),
    'access arguments' => array('access administration pages'),
    'type' => MENU_NORMAL_ITEM,
  );
  
  return $items;
}

/**
 * Form builder : contentimport specify files location form.
 */
function contentimport_form($form, &$form_state) {
  $form['files_location'] = array(
    '#type' => 'textfield',
    '#title' => t('Import files location'),
    '#description' => t('Folder names generated by the contentexport module have the following format : contenttype_dd-mm-yyyy'),
    '#size' => 80,
    '#maxlength' => 120,
    '#attributes' => array(
      'placeholder' => 'public://import/<folder name>',
    ),
    '#required' => TRUE,
  );
  $form['submit'] = array(
    '#type' => 'submit',
    '#value' => t('Submit'),
  );
  
  return $form;
}

/**
 * Form submit handler : contentimport form.
 */
function contentimport_form_submit($form, &$form_state) {
  $files_location = $form_state['values']['files_location'];
  // Trim trailing slash.
  $files_location = rtrim($files_location, '/');
  
  // Check if files location exists.
  if (!file_prepare_directory($files_location)) {
    drupal_set_message(t('The directory %directory does not exist.', array('%directory' => $files_location)), 'error');
  } else {
    _contentimport_import($files_location);
  }
  
  // Redirect to export form.
  $form_state['redirect'] = 'import/locate-files';
}

/**
 * Custom function : import data located at given location.
 */
function _contentimport_import($files_location) {
  // Check for JSON file.
  $regex = '/\.json$/';
  $options = array('recurse' => TRUE);
  $json_files = file_scan_directory($files_location, $regex, $options);
//  dpm($json_file);
  if (!empty($json_files)) {
    if (count($json_files) > 1) {
      drupal_set_message('More than one JSON file found.', 'error');
      return;
    }
  }
  else {
    drupal_set_message('No JSON file found.', 'error');
    return;
  }
//  $result = array_values($result);
//  dpm($json_files);
  
  // Check for image folder.
  $images_location = $files_location . '/image';
  if (!file_prepare_directory($files_location)) {
    drupal_set_message(t('The directory %directory does not exist.', array('%directory' => $images_location)), 'error');
    return;
  }
  
  // Load JSON data.
  $json_file = array_shift($json_files);
  $json_data = file_get_contents($json_file->uri);
  $json_data = drupal_json_decode($json_data);
  dpm($json_data);
  
  // Prepare import data
  $new_nodes = _contentimport_prepare_data($json_data);
  
  // Save new nodes.
  foreach ($new_nodes as $node) {
    node_save($node);
  }
}

/**
 * Custom function : prepare json_data for import.
 */
function _contentimport_prepare_data(array $data) {
  $import_nodes = array();
  global $user;
  
  // Cylce through data array.
  foreach ($data as $row) {
    // Build new node.
    $new_node = new stdClass();
    $new_node->type = $row['type'];
    node_object_prepare($new_node);
    $new_node->language = LANGUAGE_NONE;
    $new_node->title = $row['title'];
    $new_node->status = (boolean) $row['status'];
    $new_node->comment = (integer) $row['comment'];
    $new_node->promote = (boolean) $row['promote'];
    $new_node->sticky = (boolean) $row['sticky'];
    $new_node->uid = $user->uid;
    $new_node->body = $row['body'][$new_node->language][0]['value'];
    $new_node->image = isset($row['field_image']['und'][0]['uri']) ? $row['field_image']['und'][0]['uri'] : '';
    
    // Submit node.
    $import_nodes[] = node_submit($new_node);
  }
//  dpm($import_nodes);
  
  return $import_nodes;
}